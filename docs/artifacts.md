# Trace Capture and Azure DevOps Attachments

Playwright Pilot automatically captures test traces and can upload artifacts to Azure DevOps test results. This enables debugging failed tests directly in ADO with full trace data and error context.

## Trace Capture

Playwright automatically captures traces for all tests. The framework is configured to:

- **Capture traces for all tests** - Traces are always recorded
- **Attach traces on failure only (optional)** - Configure whether to attach traces to ADO only for failed tests
- **Store traces in `test-results/`** - Each test result directory contains a `trace.zip` file

### Configuration

Traces are configured in `playwright.config.ts`:

```typescript
export default defineConfig({
  use: {
    // Enable trace recording (retained only on failure)
    trace: "retain-on-failure",
  },
});
```

### Trace Contents

Each `trace.zip` file contains:

- Full browser interaction recording
- Network requests and responses
- Console logs
- Screenshots at key moments
- DOM snapshots

## Viewing Traces Locally

### Using trace:open Command

The quickest way to view traces is using the CLI command:

```bash
npm run pilot trace:open
```

This opens the Playwright HTML report in your browser, which includes:

- Test results overview
- Links to trace files for failed tests
- Interactive trace viewer

### Manual Viewing

You can also view traces manually:

```bash
# Open the HTML report
npx playwright show-report

# Or view a specific trace
npx playwright show-trace test-results/<test-name>/trace.zip
```

## Azure DevOps Attachments

The framework can automatically upload test artifacts to Azure DevOps test results. This enables viewing traces and error context directly in ADO.

### Environment Variables

Control artifact attachment behavior via environment variables in `.env`:

```env
# Enable/disable artifact attachments (default: true)
ADO_ATTACH_ARTIFACTS=true

# Attach only on failure (default: false)
ADO_ATTACH_ON_FAILURE_ONLY=false

# Individual artifact toggles (all default: true)
ADO_ATTACH_TRACE=true
ADO_ATTACH_ERROR_CONTEXT=true
ADO_ATTACH_LAST_RUN=true
```

### Attachment Flags

| Variable                     | Default | Description                                                              |
| ---------------------------- | ------- | ------------------------------------------------------------------------ |
| `ADO_ATTACH_ARTIFACTS`       | `true`  | Master toggle for all artifact attachments                               |
| `ADO_ATTACH_ON_FAILURE_ONLY` | `false` | If `true`, only attach artifacts for failed tests                        |
| `ADO_ATTACH_TRACE`           | `true`  | Attach `trace.zip` files                                                 |
| `ADO_ATTACH_ERROR_CONTEXT`   | `true`  | Attach `error-context.md` files (Playwright-generated)                   |
| `ADO_ATTACH_LAST_RUN`        | `true`  | Attach `.last-run.json` metadata file (includes pilot seed/run metadata) |
| `ADO_ATTACH_RUN_STATE`       | `false` | Attach `runState.json` (test.\* data from run)                           |

### How Attachments Work

1. **Tests run** - Playwright captures traces and generates error context
2. **Sync to ADO** - When you run `npm run sync:ado`, the framework:
   - Finds artifacts for each test result
   - Uploads them to ADO test case results
   - Associates them with the correct test case

### What Gets Attached

#### trace.zip

- **Location:** `test-results/<test-name>/trace.zip`
- **When:** Always captured, attached if `ADO_ATTACH_TRACE=true`
- **Contains:** Full browser trace with interactions, network, console, screenshots

#### error-context.md

- **Location:** `test-results/<test-name>/error-context.md`
- **When:** Generated by Playwright for failed tests
- **Contains:** Error details, page snapshots, stack traces
- **Note:** This is automatically generated by Playwright, not manually created

#### .last-run.json

- **Location:** `test-results/.last-run.json`
- **Contents:** Playwright run metadata + pilot metadata (seed, seedMode, startedAt, finishedAt, workers)
- **Pilot namespace:** Seed and run metadata are merged under `pilot` key
- **When:** Created after test run
- **Contains:** Metadata about the test run (timestamps, counts, etc.)

## Configuration Examples

### Attach All Artifacts (Default)

```env
ADO_ATTACH_ARTIFACTS=true
ADO_ATTACH_ON_FAILURE_ONLY=false
ADO_ATTACH_TRACE=true
ADO_ATTACH_ERROR_CONTEXT=true
ADO_ATTACH_LAST_RUN=true
```

**Result:** All artifacts are attached for all tests (passed and failed).

### Attach Only on Failure

```env
ADO_ATTACH_ARTIFACTS=true
ADO_ATTACH_ON_FAILURE_ONLY=true
ADO_ATTACH_TRACE=true
ADO_ATTACH_ERROR_CONTEXT=true
ADO_ATTACH_LAST_RUN=true
```

**Result:** Artifacts are attached only for failed tests.

### Disable Specific Artifacts

```env
ADO_ATTACH_ARTIFACTS=true
ADO_ATTACH_TRACE=true
ADO_ATTACH_ERROR_CONTEXT=false  # Don't attach error context
ADO_ATTACH_LAST_RUN=false        # Don't attach metadata
```

**Result:** Only `trace.zip` is attached.

### Disable All Attachments

```env
ADO_ATTACH_ARTIFACTS=false
```

**Result:** No artifacts are uploaded to ADO (traces are still captured locally).

## Viewing Attachments in Azure DevOps

After syncing test results to ADO:

1. Navigate to your test run in Azure DevOps
2. Open a test case result
3. Click on the **Attachments** tab
4. Download and view:
   - `trace.zip` - Open with `npx playwright show-trace trace.zip`
   - `error-context.md` - View in any markdown viewer
   - `.last-run.json` - View in any JSON viewer

## Troubleshooting

### No Trace Files Found

**Problem:** `trace.zip` files are missing from `test-results/`.

**Solutions:**

1. Check `playwright.config.ts` - Ensure `trace: "retain-on-failure"` is set
2. Check if tests passed - Traces are only retained on failure by default
3. Check disk space - Traces can be large

### Attachments Not Appearing in ADO

**Problem:** Artifacts are not showing up in Azure DevOps.

**Solutions:**

1. Check environment variables - Ensure `ADO_ATTACH_ARTIFACTS=true`
2. Check individual flags - Ensure specific artifact flags are `true`
3. Verify sync ran - Run `npm run sync:ado` after tests complete
4. Check ADO permissions - Ensure your token has permission to upload attachments

### Error Context Missing

**Problem:** `error-context.md` is not generated.

**Note:** `error-context.md` is automatically generated by Playwright for failed tests. If it's missing:

1. Ensure the test actually failed (not skipped)
2. Check Playwright version - Older versions may not generate this file
3. Check `test-results/` directory - File may be in a subdirectory

### Trace Files Are Large

**Problem:** `trace.zip` files are very large, causing slow uploads.

**Solutions:**

1. Use `ADO_ATTACH_ON_FAILURE_ONLY=true` - Only attach for failed tests
2. Consider disabling trace attachment for specific test runs
3. Clean up old trace files periodically

## Best Practices

1. **Use `ADO_ATTACH_ON_FAILURE_ONLY=true`** - Reduces upload time and storage
2. **Keep traces for debugging** - Don't disable trace capture, even if you don't attach
3. **Review attachments in ADO** - Use attachments to debug failures without local access
4. **Clean up old traces** - Periodically remove old `test-results/` directories

## File Locations

### Test Results Directory

```
test-results/
├── <test-name>/
│   ├── trace.zip           # Browser trace (if test failed)
│   └── error-context.md    # Error details (if test failed)
└── .last-run.json          # Run metadata
```

### Playwright Report

```
playwright-report/
├── index.html              # HTML report
└── trace/                  # Trace viewer assets
```

## See Also

- [README.md](./README.md) - Main documentation and bootstrap guide
- [cli.md](./cli.md) - CLI command reference (`trace:open`)
- [ado.md](./ado.md) - Azure DevOps mapping and sync
