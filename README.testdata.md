# Test Data System

Playwright Pilot provides a comprehensive test data system with three main components:

1. **Models** - TypeScript interfaces defining data structures
2. **Factories** - Functions that create model instances
3. **dataStore** - Runtime store for sharing data between tests

## Overview

### Models

Models are explicit TypeScript interfaces that define data structures. They live in `src/testdata/models/` and are manually created or generated by the CLI.

**Example Model:**

```typescript
// src/testdata/models/user.ts
export interface User {
  id: string;
  email: string;
  password: string;
  firstName: string;
  lastName: string;
}
```

### Factories

Factories are functions that create model instances. They use faker (or manual values) to generate test data. Factories are **object creation only** - they do not include persistence methods.

**Example Factory:**

```typescript
// src/testdata/factories/user.factory.ts
import { faker } from "@faker-js/faker";
import type * as models from "../models";

export function createUser(overrides?: Partial<models.User>) {
  const user: models.User = {
    id: faker.string.uuid(),
    email: faker.internet.email(),
    password: faker.internet.password(),
    firstName: faker.person.firstName(),
    lastName: faker.person.lastName(),
    ...overrides,
  };

  return user;
}
```

**Important:** Factories do not include `.save()` methods. Use `set/get` from dataStore instead.

### dataStore

The dataStore provides two APIs:

1. **Runtime API** (`set/get`) - For test-run state sharing (primary API)
2. **Persistent API** (`save/load`) - For system-owned, repo-stored non-secret data (rare)

## Key Naming Rules

### system.* Keys

- **Canonical** - Assumed to exist, not casually overwritten
- **System-owned** - Managed by framework or team conventions
- **Persistent** - Stored in `src/testdata/dataStore.json`
- **Use `save/load`** - For storing system keys

Examples:
- `system.salesforce.users.admin`
- `system.salesforce.users.sales`

### test.* Keys

- **Test-owned** - Safe to overwrite
- **Runtime** - Not persisted to JSON (unless using `save/load`)
- **Use `set/get`** - Primary API for test data

Examples:
- `test.user`
- `test.product`
- `test.appointment`

## Runtime API: set/get

**Use `set/get` by default** for test-run state sharing. This is the primary API for test data.

### Setting Data

```typescript
import { set } from "../../../src/utils/dataStore";
import * as factories from "../../../src/testdata/factories";

// Create and store test data
const user = factories.createUser();
await set("test.user", user);

// With overrides
const adminUser = factories.createUser({ email: "admin@example.com" });
await set("test.admin", adminUser);
```

### Getting Data

```typescript
import { get } from "../../../src/utils/dataStore";

// Get test data
const user = await get<models.User>("test.user");
if (!user) {
  throw new Error("User data not found");
}

// Use in test
await page.fill('[data-testid="email"]', user.email);
await page.fill('[data-testid="password"]', user.password);
```

### Complete Example

```typescript
import { test } from "../../fixtures/test-fixtures";
import { set, get } from "../../../src/utils/dataStore";
import * as factories from "../../../src/testdata/factories";
import type * as models from "../../../src/testdata/models";

test.describe.serial("USER-101 - User Management @user-management", () => {
  test("[USER-10001] Create and use test data", async ({ page, userManagementPage }) => {
    // Create test data
    const user = factories.createUser();
    await set("test.user", user);

    // Get test data
    const userData = await get<models.User>("test.user");
    if (!userData) {
      throw new Error("User data not found in data store.");
    }

    // Use in test
    await test.step("Navigate to user management", async () => {
      await userManagementPage.navigateToUserManagement();
    });

    await test.step("Use user data", async () => {
      await userManagementPage.fillEmail(userData.email);
      await userManagementPage.fillPassword(userData.password);
    });
  });
});
```

## Persistent API: save/load

**Use `save/load` rarely** - Only for system-owned, repo-stored non-secret data.

### When to Use save/load

- Storing canonical system data (e.g., Salesforce user emails)
- Data that should persist across test runs
- Non-secret data that can be committed to the repo

### When NOT to Use save/load

- ❌ Test-run state (use `set/get`)
- ❌ Secrets or credentials (use environment variables)
- ❌ Dynamic test data (use `set/get`)

### Using save/load

```typescript
import { save, load } from "../../../src/utils/dataStore";
import { systemKeys } from "../../../src/utils/dataStore";

// Save system data
await save("system.salesforce.users.admin", {
  email: "admin@example.com",
  // ... other fields
});

// Load system data
const adminUser = await load("system.salesforce.users.admin");
```

### systemKeys for Type Safety

The `systemKeys` object provides IDE autocomplete and safer keys:

```typescript
import { systemKeys } from "../../../src/utils/dataStore";

// Type-safe system key access
const adminEmail = await get(systemKeys.salesforce.users.admin);
```

**systemKeys Definition:**

```typescript
// src/testdata/systemKeys.ts
export const systemKeys = {
  salesforce: {
    users: {
      admin: "system.salesforce.users.admin",
      sales: "system.salesforce.users.sales",
      accountManager: "system.salesforce.users.accountManager",
    },
  },
} as const;
```

## Best Practices

### Use set/get by Default

```typescript
// ✅ Good: Use set/get for test-run state
const user = factories.createUser();
await set("test.user", user);
const userData = await get<models.User>("test.user");
```

### Use save/load for System Data Only

```typescript
// ✅ Good: Use save/load for canonical system data
await save("system.salesforce.users.admin", {
  email: "admin@example.com",
});
const adminUser = await load("system.salesforce.users.admin");
```

### Avoid saveAny/loadAny

```typescript
// ❌ Avoid: Use typed APIs instead
await saveAny("test.user", user); // Not type-safe

// ✅ Good: Use typed APIs
await set("test.user", user);
```

**Exception:** Only use `saveAny/loadAny` if legacy compatibility requires it.

### Type Safety

Always use TypeScript types with `get`:

```typescript
// ✅ Good: Type-safe
const user = await get<models.User>("test.user");

// ❌ Avoid: Untyped
const user = await get("test.user");
```

## Creating Models and Factories

### Using the CLI

```bash
# Create a factory (will create model if it doesn't exist)
npm run pilot factory:add "Product"
```

The CLI will:
1. Check if model exists (prompts to reuse or create new)
2. Create model file with placeholder interface
3. Create factory file with basic structure
4. Update barrel exports

**Important:** After creation, you must:
- Manually add fields to the model interface
- Manually add faker methods to the factory

### Manual Creation

**1. Create Model:**

```typescript
// src/testdata/models/product.ts
export interface Product {
  id: string;
  name: string;
  price: number;
  description: string;
}
```

**2. Export in Models Index:**

```typescript
// src/testdata/models/index.ts
export * from "./product";
```

**3. Create Factory:**

```typescript
// src/testdata/factories/product.factory.ts
import { faker } from "@faker-js/faker";
import type * as models from "../models";

export function createProduct(overrides?: Partial<models.Product>) {
  const product: models.Product = {
    id: faker.string.uuid(),
    name: faker.commerce.productName(),
    price: faker.number.float({ min: 0, max: 1000, fractionDigits: 2 }),
    description: faker.commerce.productDescription(),
    ...overrides,
  };

  return product;
}
```

**4. Export in Factories Index:**

```typescript
// src/testdata/factories/index.ts
export * from "./product.factory";
```

## Examples

### Creating and Using Test Data

```typescript
import { test } from "../../fixtures/test-fixtures";
import { set, get } from "../../../src/utils/dataStore";
import * as factories from "../../../src/testdata/factories";
import type * as models from "../../../src/testdata/models";

test.describe.serial("APPT-101 - Appointments @appointments", () => {
  test("[APPT-10001] Create appointment with user data", async ({ page, appointmentPage }) => {
    // Create user
    const user = factories.createUser();
    await set("test.user", user);

    // Create appointment
    const appointment = factories.createAppointment({ userId: user.id });
    await set("test.appointment", appointment);

    // Get data
    const userData = await get<models.User>("test.user");
    const appointmentData = await get<models.Appointment>("test.appointment");

    if (!userData || !appointmentData) {
      throw new Error("Required data not found");
    }

    // Use in test
    await appointmentPage.navigateToAppointments();
    await appointmentPage.createAppointment(appointmentData);
  });
});
```

### Storing Canonical System Data

```typescript
import { save, load, systemKeys } from "../../../src/utils/dataStore";

// Save canonical Salesforce user emails (non-secret, can be committed)
await save(systemKeys.salesforce.users.admin, {
  email: "admin@example.com",
  // ... other fields
});

// Load in tests
const adminUser = await load(systemKeys.salesforce.users.admin);
```

## Data Store File Location

The persistent data store lives at:

```
src/testdata/dataStore.json
```

This file is:
- ✅ Committed to the repo (for system keys)
- ✅ Used by `save/load` API
- ❌ Not used by `set/get` API (runtime only)

## See Also

- [README.md](./README.md) - Main documentation and bootstrap guide
- [README.cli.md](./README.cli.md) - CLI command reference (factory creation)
- [README.login.md](./README.login.md) - AutoPilot usage (may reference stored system users)
